{% extends "base.html" %}

{% block content %}
<div class="container my-3 text-light">

  <div class="card bg-dark mb-3">
    <div class="card-body">
      <h2 class="card-title d-flex justify-content-between align-items-center">
        {{ task.name }}
        <span>
          <span class="badge {% if task.is_complete %}bg-success{% else %}bg-warning{% endif %}">
            {{ task.get_status_display }}
          </span>
          <a href="{% url 'task-update' pk=task.id %}" class="btn btn-sm btn-outline-primary ms-2">Update</a>
          <a href="{% url 'task-delete' pk=task.id %}?next={{ task.get_absolute_url }}" class="btn btn-sm btn-outline-danger ms-1">Delete</a>
        </span>
      </h2>
      <p class="card-subtitle mb-2 text-muted">ID: {{ task.id }}</p>

      <ul class="list-unstyled mb-0">
        <li><strong>Deadline:</strong> {{ task.deadline|time:"H:i" }} {{ task.deadline|date:"d.m" }}</li>
        <li><strong>Priority:</strong> <span class="badge bg-info">{{ task.get_priority_display }}</span></li>
        <li><strong>Task Type:</strong> {{ task.task_type }}</li>
        <li><strong>Created at:</strong> {{ task.created_at|time:"H:i" }} {{ task.created_at|date:"d.m" }}</li>
        {% if task.updated_at %}
        <li><strong>Updated at:</strong> {{ task.updated_at|time:"H:i" }} {{ task.updated_at|date:"d.m" }}</li>
        {% endif %}
      </ul>
    </div>
  </div>

  <div class="card bg-dark mb-3">
    <div class="card-body">
      <h4>Assignees</h4>
      <ul>
        {% for user in task.assignee.all %}
          <li>{{ user }}</li>
        {% empty %}
          <li>—</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="card bg-dark mb-3">
    <div class="card-body">
      <h4>Description</h4>
      <p>{{ task.description }}</p>
    </div>
  </div>

  <div class="card bg-dark">
    <div class="card-body">
      <h4>Comments ({{ comments|length }})</h4>

      {% for comment in comments %}
        <div class="card bg-secondary mb-2">
          <div class="card-body p-2">
            <div class="d-flex justify-content-between align-items-center">
              <small><a href="{{ comment.author.get_absolute_url }}" class="text-light">{{ comment.author }}</a> — {{ comment.created_at|time:"H:i" }} {{ comment.created_at|date:"d.m" }} {% if comment.updated_at and comment.updated_at > comment.created_at %}(edited){% endif %}</small>
              <span>
                <a href="{% url 'comment-update' pk=comment.id %}" class="btn btn-sm btn-outline-light">Edit</a>
                <a href="{% url 'comment-delete' pk=comment.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
              </span>
            </div>
            <p class="mb-0">{{ comment.content|linebreaksbr }}</p>
          </div>
        </div>
      {% empty %}
        <p>No comments yet.</p>
      {% endfor %}

      {% if user.is_authenticated %}
        <form method="post" class="mt-3">
          {% csrf_token %}
          <div class="mb-2">
            {{ comment_form.content }}
            {% if comment_form.content.errors %}
              <div class="text-danger">{{ comment_form.content.errors }}</div>
            {% endif %}
          </div>
          <button type="submit" class="btn btn-primary btn-sm">Add comment</button>
        </form>
      {% else %}
        <p><a href="{% url 'login' %}?next={{ request.path }}">Login</a> to add comments.</p>
      {% endif %}

    </div>
  </div>

</div>
{% endblock %}

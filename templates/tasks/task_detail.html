{% extends "base.html" %}

{% block content %}
  <div class="task-detail">

    <div class="task-header">
      <h1>
        {{ task.name }}
        <span class="status-indicator {% if task.is_complete %}complete{% else %}in-progress{% endif %}"></span>
        <a href="{% url 'task-update' pk=task.id %}">Update</a>
        <a href="{% url 'task-delete' pk=task.id %}">Delete</a>
      </h1>
      <h4>
        ID: {{ task.id }}
        <br>
        Status: {{ task.status }}
      </h4>
    </div>

    <div class="task-info">
      <p><strong>Deadline:</strong> {{ task.deadline|time:"H:i" }} {{ task.deadline|date:"d.m" }}</p>
      <p><strong>Priority:</strong>
        <span class="priority-indicator {{ task.priority }}">
          {{ task.get_priority_display }}
        </span>
      </p>
      <p><strong>Task Type:</strong> {{ task.task_type }}</p>
      <p><strong>Created at:</strong> {{ task.created_at|time:"H:i" }} {{ task.created_at|date:"d.m" }}</p>
      {% if task.updated_at %}
        <p><strong>Updated at:</strong> {{ task.updated_at|time:"H:i" }} {{ task.updated_at|date:"d.m" }}</p>
      {% endif %}
    </div>

    <div class="task-assignees">
      <strong>Assignees:</strong>
      <ul>
        {% for user in task.assignee.all %}
          <li>{{ user }}</li>
        {% empty %}
          <li>—</li>
        {% endfor %}
      </ul>
    </div>

    <div class="task-description">
      <h3>Description</h3>
      <p>{{ task.description }}</p>
    </div>

  {# ====== Comments block ====== #}
    <div class="task-comments">
      <h3>Comments ({{ comments|length }})</h3>

      {# List comments #}
      <ul class="comment-list list-unstyled">
        {% for comment in comments %}
          <li id="comment-{{ comment.id }}" class="media mb-3">
            <div class="media-body">
              <div class="comment-meta">
                <a href="{{ comment.author.get_absolute_url }}">{{ comment.author }}</a>
                <small class="text-muted"> — {{ comment.created_at|time:"H:i" }} {{ comment.created_at|date:"d.m" }}</small>
                {% if comment.updated_at and comment.updated_at > comment.created_at %}
                  <small class="text-muted"> (edited)</small>
                {% endif %}
              </div>

              <div class="comment-body mt-1">
                {{ comment.content|linebreaksbr }}
              </div>
            </div>
          </li>
        {% empty %}
          <li>No comments yet.</li>
        {% endfor %}
      </ul>

      {# Form comments #}
      {% if user.is_authenticated %}
        <form method="post" class="comment-form mb-3">
          {% csrf_token %}

          <div class="form-group">
            {{ comment_form.content }}
            {% if comment_form.content.errors %}
              <div class="text-danger">{{ comment_form.content.errors }}</div>
            {% endif %}
          </div>

          <button type="submit" class="btn btn-primary">Add comment</button>
        </form>
      {% else %}
        <p><a href="{% url 'login' %}?next={{ request.path }}">Login</a> to add comments.</p>
      {% endif %}

    </div>
  {# ====== /Comments block ====== #}

  </div>
{% endblock %}

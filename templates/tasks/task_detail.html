{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="{% url 'task-list' %}" class="small text-primary">Tasks</a></li>
        <li class="breadcrumb-item active small" aria-current="page">#{{ task.id }}</li>
      </ol>
    </nav>
    <h1 class="h3 fw-bold mb-0">{{ task.name }}</h1>
  </div>

  <div class="d-flex gap-2">
    <a href="{% url 'task-update' pk=task.id %}" class="btn btn-primary btn-sm shadow-sm">
      <i class="bi bi-pencil"></i> Update
    </a>
    <a href="{% url 'task-delete' pk=task.id %}?next={% url 'task-list' %}" class="btn btn-danger-soft btn-sm">
      <i class="bi bi-trash"></i> Delete
    </a>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="mb-5">
      <h5 class="fw-semibold mb-3">Description</h5>
      <div class="p-3 bg-body-tertiary rounded-3 border shadow-sm">
        {{ task.description|default:"No description provided."|linebreaks }}
      </div>
    </div>

    <div class="comments-section">
      <h5 class="fw-semibold mb-3">Comments ({{ comments|length }})</h5>

      <div class="d-flex flex-column gap-3 mb-4">
        {% for comment in comments %}
          <div class="p-3 border rounded-3 bg-white shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <span class="fw-bold text-primary small">@{{ comment.author.username }}</span>
                <span class="text-muted small ms-2">{{ comment.created_at|date:"d M, H:i" }}</span>
                {% if comment.updated_at and comment.updated_at > comment.created_at %}
                  <span class="badge bg-light text-muted fw-normal">edited</span>
                {% endif %}
              </div>

              {% if user.is_authenticated and user.id == comment.author.id %}
                <ul class="d-flex gap-2 list-unstyled mb-0 ps-0">
                  <li><a class="btn btn-ghost btn-sm shadow-sm" href="{% url 'comment-update' pk=comment.id %}">Edit</a></li>
                  <li><a class="btn btn-danger-ghost btn-sm" href="{% url 'comment-delete' pk=comment.id %}">Delete</a></li>
                </ul>
              {% endif %}
            </div>
            <p class="mb-0 small text-secondary">{{ comment.content|linebreaksbr }}</p>
          </div>
        {% empty %}
          <p class="text-muted small italic">No comments yet.</p>
        {% endfor %}
      </div>

      {% if user.is_authenticated %}
        <div class="p-3 bg-light border rounded-3">
          <form method="post">
            {% csrf_token %}
            <div class="mb-2">
              {{ comment_form.content }}
            </div>
            <button type="submit" class="btn btn-primary btn-sm px-4">Post Comment</button>
          </form>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card border-0 border-top border-3 border-primary shadow-sm bg-body-tertiary">
      <div class="card-body">
        <h6 class="fw-bold mb-3 text-uppercase small text-muted">Task Details</h6>

        <ul class="list-unstyled mb-0">
          <li class="mb-3">
            <label class="d-block small text-muted mb-1">Status</label>
            <span class="badge {% if task.is_complete %}bg-success-subtle text-success{% else %}bg-warning-subtle text-warning-emphasis{% endif %} border px-3">
                {{ task.get_status_display }}
            </span>
          </li>

          <li class="mb-3">
            <label class="d-block small text-muted mb-1">Priority</label>
            <span class="badge bg-info-subtle text-info-emphasis border px-3">
                {{ task.get_priority_display }}
            </span>
          </li>

          <li class="mb-3">
            <label class="d-block small text-muted mb-1">Deadline</label>
            <span class="fw-medium text-dark"><i class="bi bi-calendar-event me-1"></i> {{ task.deadline|date:"d M, H:i" }}</span>
          </li>

          <li class="mb-3">
            <label class="d-block small text-muted mb-1">Task Type</label>
            <span class="badge bg-secondary-subtle text-secondary-emphasis border">{{ task.task_type }}</span>
          </li>

          <hr>

          <li class="mb-1">
            <label class="d-block small text-muted mb-2">Assignees</label>
            <div class="d-flex flex-wrap gap-2">
              {% for user in task.assignee.all %}
                <div class="d-flex align-items-center bg-white border rounded-pill px-2 py-1 shadow-sm">
                  <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 20px; height: 20px; font-size: 10px;">
                    {{ user.username|slice:":1"|upper }}
                  </div>
                  <span class="small fw-medium">{{ user.username }}</span>
                </div>
              {% empty %}
                <span class="text-muted small">â€”</span>
              {% endfor %}
            </div>
          </li>
        </ul>
      </div>
    </div>

    <div class="mt-4 px-2">
        <p class="text-muted" style="font-size: 0.75rem;">
            Created: {{ task.created_at|date:"d.m.Y H:i" }}<br>
            {% if task.updated_at %}Last update: {{ task.updated_at|date:"d.m.Y H:i" }}{% endif %}
        </p>
    </div>
  </div>
</div>
{% endblock %}